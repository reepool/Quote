# å†å²æ•°æ®ä¸‹è½½åŠŸèƒ½

## ğŸ“– åŠŸèƒ½æ¦‚è¿°

å†å²æ•°æ®ä¸‹è½½æ˜¯ Quote System çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæ”¯æŒå¤šç§ä¸‹è½½æ¨¡å¼å’Œçµæ´»çš„é…ç½®é€‰é¡¹ã€‚ç³»ç»Ÿæä¾›äº†ä»å…¨é‡ä¸‹è½½åˆ°ç²¾ç¡®æ—¥æœŸèŒƒå›´ä¸‹è½½çš„å®Œæ•´è§£å†³æ–¹æ¡ˆã€‚

## ğŸš€ ä¸»è¦ç‰¹æ€§

### 1. å¤šç§ä¸‹è½½æ¨¡å¼
- **å…¨é‡å†å²ä¸‹è½½**ï¼šä¸‹è½½æŒ‡å®šäº¤æ˜“æ‰€çš„æ‰€æœ‰å†å²æ•°æ®
- **æŒ‡å®šæ—¥æœŸèŒƒå›´ä¸‹è½½**ï¼šç²¾ç¡®æ§åˆ¶ä¸‹è½½çš„æ—¥æœŸèŒƒå›´
- **æŒ‰å¹´ä»½ä¸‹è½½**ï¼šæ”¯æŒæŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªå¹´ä»½
- **ç»­ä¼ ä¸‹è½½**ï¼šæ”¯æŒä¸­æ–­åçš„æ–­ç‚¹ç»­ä¼ 

### 2. æ™ºèƒ½ä¸‹è½½ç­–ç•¥
- **ç²¾ç¡®ä¸‹è½½æ¨¡å¼**ï¼šåŸºäºè‚¡ç¥¨ä¸Šå¸‚æ—¥æœŸè®¡ç®—ä¸‹è½½èŒƒå›´
- **åˆ†å—ä¸‹è½½**ï¼šæ”¯æŒçµæ´»çš„åˆ†å—ç­–ç•¥
- **è´¨é‡è¯„ä¼°**ï¼šå®æ—¶æ•°æ®è´¨é‡è¯„åˆ†
- **è‡ªåŠ¨è¿‡æ»¤**ï¼šé¿å…æ— æ•ˆè¯·æ±‚

### 3. å®¹é”™å’Œæ¢å¤
- **æ–­ç‚¹ç»­ä¼ **ï¼šä¸‹è½½ä¸­æ–­åè‡ªåŠ¨æ¢å¤
- **é”™è¯¯é‡è¯•**ï¼šæ™ºèƒ½é‡è¯•æœºåˆ¶
- **è¿›åº¦è·Ÿè¸ª**ï¼šè¯¦ç»†çš„ä¸‹è½½è¿›åº¦è®°å½•

## ğŸ“‹ æ”¯æŒçš„äº¤æ˜“æ‰€

| äº¤æ˜“æ‰€ä»£ç  | äº¤æ˜“æ‰€åç§° | æ”¯æŒçŠ¶æ€ |
|-----------|-----------|----------|
| SSE | ä¸Šæµ·è¯åˆ¸äº¤æ˜“æ‰€ | âœ… å®Œå…¨æ”¯æŒ |
| SZSE | æ·±åœ³è¯åˆ¸äº¤æ˜“æ‰€ | âœ… å®Œå…¨æ”¯æŒ |
| BSE | åŒ—äº¬è¯åˆ¸äº¤æ˜“æ‰€ | âœ… å®Œå…¨æ”¯æŒ |
| HKEX | é¦™æ¸¯äº¤æ˜“æ‰€ | ğŸš§ å¼€å‘ä¸­ |
| NASDAQ | çº³æ–¯è¾¾å…‹ | ğŸš§ å¼€å‘ä¸­ |
| NYSE | çº½çº¦è¯åˆ¸äº¤æ˜“æ‰€ | ğŸš§ å¼€å‘ä¸­ |

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬å‘½ä»¤æ ¼å¼
```bash
python main.py download [å‚æ•°]
```

### å‘½ä»¤å‚æ•°è¯¦è§£

#### äº¤æ˜“æ‰€é€‰æ‹©
```bash
--exchanges SSE SZSE BSE  # æŒ‡å®šäº¤æ˜“æ‰€åˆ—è¡¨
--preset a_shares         # ä½¿ç”¨å¸‚åœºé¢„è®¾ç»„åˆ
```

#### æ—¥æœŸèŒƒå›´æŒ‡å®š
```bash
# æŒ‡å®šå®Œæ•´æ—¥æœŸèŒƒå›´
--start-date 2024-01-01 --end-date 2024-12-31

# åªæŒ‡å®šå¼€å§‹æ—¥æœŸï¼ˆåˆ°ä»Šå¤©ï¼‰
--start-date 2024-06-01

# åªæŒ‡å®šç»“æŸæ—¥æœŸï¼ˆä»å¼€å§‹ï¼‰
--end-date 2024-12-31

# æŒ‰å¹´ä»½ä¸‹è½½
--years 2023 2024
```

#### ç»­ä¼ æ§åˆ¶
```bash
--resume       # å¯ç”¨ç»­ä¼ ï¼ˆé»˜è®¤ï¼‰
--no-resume    # ç¦ç”¨ç»­ä¼ ï¼Œé‡æ–°å¼€å§‹
```

## ğŸ“Š ä¸‹è½½åœºæ™¯å’Œé€»è¾‘

### åœºæ™¯1ï¼šå…¨å†å²æ•°æ®ä¸‹è½½
```bash
python main.py download --exchanges SSE SZSE
python main.py download --preset a_shares
```

**ç‰¹ç‚¹ï¼š**
- ä»æ•°æ®æºè·å–æœ€æ–°äº¤æ˜“æ—¥å†
- ä¸‹è½½ä»è‚¡ç¥¨ä¸Šå¸‚æ—¥æœŸåˆ°æ˜¨å¤©çš„æ‰€æœ‰æ•°æ®
- é€‚åˆé¦–æ¬¡ä½¿ç”¨æˆ–å®Œæ•´æ›´æ–°

**æµç¨‹ï¼š**
1. æ›´æ–°äº¤æ˜“æ—¥å†ï¼ˆä»æ•°æ®æºï¼‰
2. è·å–è‚¡ç¥¨åˆ—è¡¨å’Œä¸Šå¸‚æ—¥æœŸ
3. è®¡ç®—æ¯ä¸ªè‚¡ç¥¨çš„ä¸‹è½½èŒƒå›´
4. æ‰¹é‡ä¸‹è½½æ•°æ®
5. è´¨é‡è¯„ä¼°å’Œä¿å­˜

### åœºæ™¯2ï¼šæŒ‡å®šæ—¥æœŸèŒƒå›´ä¸‹è½½
```bash
python main.py download --exchanges SZSE --start-date 2024-06-01 --end-date 2024-12-31
```

**ç‰¹ç‚¹ï¼š**
- ä½¿ç”¨ç¼“å­˜çš„äº¤æ˜“æ—¥å†
- åªä¸‹è½½æŒ‡å®šæ—¥æœŸèŒƒå›´å†…çš„æ•°æ®
- é€‚åˆæ•°æ®è¡¥å…¨å’Œç‰¹å®šåˆ†æ

**æµç¨‹ï¼š**
1. ä½¿ç”¨ç¼“å­˜çš„äº¤æ˜“æ—¥å†
2. ç­›é€‰æŒ‡å®šæ—¥æœŸèŒƒå›´å†…çš„äº¤æ˜“æ—¥
3. æ‰¹é‡ä¸‹è½½æ•°æ®
4. è´¨é‡è¯„ä¼°å’Œä¿å­˜

### åœºæ™¯3ï¼šç»­ä¼ ä¸‹è½½
```bash
python main.py download --exchanges SSE SZSE --resume
```

**ç‰¹ç‚¹ï¼š**
- ä»ä¸Šæ¬¡ä¸­æ–­çš„ä½ç½®ç»§ç»­
- ä½¿ç”¨ç¼“å­˜çš„äº¤æ˜“æ—¥å†
- ä¿æŒä¸‹è½½è¿›åº¦

**æµç¨‹ï¼š**
1. è¯»å–ä¸‹è½½è¿›åº¦æ–‡ä»¶
2. è®¡ç®—æœªå®Œæˆçš„æ‰¹æ¬¡
3. ä»ä¸­æ–­å¤„ç»§ç»­ä¸‹è½½
4. æ›´æ–°è¿›åº¦

## âš™ï¸ æ ¸å¿ƒç±»å’Œæ–¹æ³•

### DataManager ç±»
```python
class DataManager:
    async def download_all_historical_data(
        self,
        exchanges: List[str] = None,
        start_date: date = None,
        end_date: date = None,
        resume: bool = True,
        quality_threshold: float = 0.7,
        force_update_calendar: bool = True
    )
```

**å‚æ•°è¯´æ˜ï¼š**
- `exchanges`: äº¤æ˜“æ‰€åˆ—è¡¨
- `start_date`: å¼€å§‹æ—¥æœŸï¼ˆå¯é€‰ï¼‰
- `end_date`: ç»“æŸæ—¥æœŸï¼ˆå¯é€‰ï¼‰
- `resume`: æ˜¯å¦å¯ç”¨ç»­ä¼ 
- `quality_threshold`: æ•°æ®è´¨é‡é˜ˆå€¼
- `force_update_calendar`: æ˜¯å¦å¼ºåˆ¶æ›´æ–°äº¤æ˜“æ—¥å†

### æ ¸å¿ƒæ–¹æ³•

#### 1. `_download_exchange_precise()`
ç²¾ç¡®ä¸‹è½½æ¨¡å¼ï¼ŒåŸºäºä¸Šå¸‚æ—¥æœŸè®¡ç®—ä¸‹è½½èŒƒå›´ã€‚

```python
async def _download_exchange_precise(
    self,
    exchange: str,
    instruments: List[Dict],
    start_date: date,
    end_date: date,
    quality_threshold: float,
    resume: bool = False
)
```

#### 2. `_download_instrument_by_trading_days()`
æŒ‰äº¤æ˜“æ—¥ä¸‹è½½å•ä¸ªè‚¡ç¥¨æ•°æ®ã€‚

```python
async def _download_instrument_by_trading_days(
    self,
    instrument: Dict,
    exchange: str,
    trading_days: List[date],
    quality_threshold: float
) -> List[Dict]
```

#### 3. `_update_trading_calendar()`
æ›´æ–°äº¤æ˜“æ—¥å†ã€‚

```python
async def _update_trading_calendar(
    self,
    exchange: str,
    start_date: date,
    end_date: date
)
```

## ğŸ“ˆ ä¸‹è½½è¿›åº¦è·Ÿè¸ª

### è¿›åº¦æ–‡ä»¶ç»“æ„
```json
{
  "batch_id": "20251011_154830",
  "total_instruments": 5159,
  "processed_instruments": 2909,
  "successful_downloads": 2909,
  "failed_downloads": 0,
  "total_quotes": 10000000,
  "trading_days_processed": 0,
  "total_trading_days": 0,
  "data_gaps_detected": 0,
  "quality_issues": 0,
  "start_time": "2025-10-11T15:48:30.123456+08:00",
  "current_exchange": "SZSE",
  "errors": []
}
```

### å­—æ®µè¯´æ˜
- `batch_id`: ä¸‹è½½æ‰¹æ¬¡ID
- `total_instruments`: æ€»è‚¡ç¥¨æ•°é‡
- `processed_instruments`: å·²å¤„ç†è‚¡ç¥¨æ•°é‡
- `successful_downloads`: æˆåŠŸä¸‹è½½æ•°é‡
- `failed_downloads`: å¤±è´¥ä¸‹è½½æ•°é‡
- `total_quotes`: æ€»è¡Œæƒ…æ•°æ®é‡
- `data_gaps_detected`: æ£€æµ‹åˆ°çš„æ•°æ®ç¼ºå£
- `quality_issues`: è´¨é‡é—®é¢˜æ•°é‡
- `current_exchange`: å½“å‰å¤„ç†çš„äº¤æ˜“æ‰€

## ğŸ¯ ä¸šåŠ¡é€»è¾‘è¯¦è§£

### 1. äº¤æ˜“æ—¥å†è·å–ç­–ç•¥

**å…¨å†å²ä¸‹è½½ï¼š**
- ä»æ•°æ®æºè·å–æœ€æ–°äº¤æ˜“æ—¥å†
- ç¡®ä¿æ•°æ®çš„å‡†ç¡®æ€§

**æŒ‡å®šæ—¥æœŸä¸‹è½½ï¼š**
- ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„äº¤æ˜“æ—¥å†
- æé«˜ä¸‹è½½æ•ˆç‡

**ç»­ä¼ ä¸‹è½½ï¼š**
- ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„äº¤æ˜“æ—¥å†
- é¿å…é‡å¤è·å–

### 2. æ‰¹æ¬¡å¤„ç†é€»è¾‘

```python
# æ‰¹æ¬¡å¤§å°é…ç½®
batch_size = 50  # æ¯æ‰¹å¤„ç†50åªè‚¡ç¥¨

# æ‰¹æ¬¡è®¡ç®—
for batch_idx, batch in enumerate(batches, 1):
    if batch_idx < start_batch:
        continue  # è·³è¿‡å·²å®Œæˆçš„æ‰¹æ¬¡
    # å¤„ç†å½“å‰æ‰¹æ¬¡
```

### 3. ç»­ä¼ é€»è¾‘ä¿®å¤

**ä¿®å¤å‰çš„é—®é¢˜ï¼š**
- ä½¿ç”¨ç´¯è®¡çš„ `processed_instruments` è®¡ç®—æ‰¹æ¬¡
- å¯¼è‡´è·¨äº¤æ˜“æ‰€æ—¶æ‰¹æ¬¡è®¡ç®—é”™è¯¯

**ä¿®å¤åçš„é€»è¾‘ï¼š**
```python
# æŒ‰äº¤æ˜“æ‰€å•ç‹¬è®¡ç®—å·²å¤„ç†æ•°é‡
if exchange == 'SZSE' and resume:
    sse_count = await self.db_ops.get_instruments_by_exchange('SSE')
    exchange_processed = max(0, self.progress.processed_instruments - len(sse_count))

processed_batches = (exchange_processed // batch_size)
start_batch = processed_batches + 1
```

## ğŸ”§ é…ç½®é€‰é¡¹

### config.json é…ç½®
```json
{
  "data_config": {
    "download_chunk_days": 2000,  // åˆ†å—ä¸‹è½½å¤§å°
    "batch_size": 50,              // æ‰¹å¤„ç†å¤§å°
    "quality_threshold": 0.7,      // è´¨é‡é˜ˆå€¼
    "resume_enabled": true         // æ˜¯å¦å¯ç”¨ç»­ä¼ 
  }
}
```

### ä¸€æ¬¡æ€§ä¸‹è½½æ¨¡å¼
è®¾ç½® `download_chunk_days: 0` å¯ä»¥å¯ç”¨ä¸€æ¬¡æ€§ä¸‹è½½æ¨¡å¼ï¼Œä¸€æ¬¡æ€§è·å–æ‰€æœ‰å†å²æ•°æ®ã€‚

## ğŸ“Š æ€§èƒ½ç›‘æ§

### ä¸‹è½½é€Ÿåº¦ä¼˜åŒ–
- **æ‰¹é‡è¯·æ±‚**ï¼šå‡å°‘ç½‘ç»œè¯·æ±‚æ¬¡æ•°
- **å¹¶å‘æ§åˆ¶**ï¼šåˆç†çš„å¹¶å‘æ•°é‡
- **é™æµæœºåˆ¶**ï¼šé¿å…è§¦å‘æ•°æ®æºé™åˆ¶

### å†…å­˜ç®¡ç†
- **åˆ†æ‰¹å¤„ç†**ï¼šé¿å…å†…å­˜æº¢å‡º
- **åŠæ—¶é‡Šæ”¾**ï¼šå¤„ç†å®Œç«‹å³é‡Šæ”¾å†…å­˜
- **ç¼“å­˜ç­–ç•¥**ï¼šåˆç†ä½¿ç”¨ç¼“å­˜

## ğŸš¨ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯ç±»å‹
1. **ç½‘ç»œé”™è¯¯**ï¼šæ•°æ®æºè¿æ¥å¤±è´¥
2. **æ•°æ®é”™è¯¯**ï¼šè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸
3. **å­˜å‚¨é”™è¯¯**ï¼šæ•°æ®åº“å†™å…¥å¤±è´¥
4. **æƒé™é”™è¯¯**ï¼šæ•°æ®æºè®¿é—®æƒé™ä¸è¶³

### é”™è¯¯æ¢å¤æœºåˆ¶
- **è‡ªåŠ¨é‡è¯•**ï¼šé…ç½®é‡è¯•æ¬¡æ•°å’Œé—´éš”
- **é™çº§ç­–ç•¥**ï¼šä¸»æ•°æ®æºå¤±è´¥æ—¶åˆ‡æ¢å¤‡ç”¨æº
- **é”™è¯¯è®°å½•**ï¼šè¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•

## ğŸ“ æœ€ä½³å®è·µ

### 1. é¦–æ¬¡ä½¿ç”¨
```bash
# æ¨èå…ˆä¸‹è½½å°‘é‡æ•°æ®æµ‹è¯•
python main.py download --exchanges SSE --start-date 2024-01-01 --end-date 2024-01-31

# ç¡®è®¤æ— è¯¯åå†è¿›è¡Œå…¨é‡ä¸‹è½½
python main.py download --exchanges SSE SZSE
```

### 2. æ•°æ®è¡¥å…¨
```bash
# è¡¥å……ç‰¹å®šæ—¥æœŸèŒƒå›´çš„æ•°æ®
python main.py download --exchanges SZSE --start-date 2024-06-01 --end-date 2024-06-30
```

### 3. ç»­ä¼ ä½¿ç”¨
```bash
# ä¸‹è½½ä¸­æ–­åç»§ç»­
python main.py download --exchanges SSE SZSE --resume

# é‡æ–°å¼€å§‹ï¼ˆå¿½ç•¥ä¹‹å‰è¿›åº¦ï¼‰
python main.py download --exchanges SSE SZSE --no-resume
```

## ğŸ”„ ç‰ˆæœ¬æ›´æ–°æ—¥å¿—

### v2.1.0 (2025-10-11)
- âœ¨ æ–°å¢æŒ‡å®šæ—¥æœŸèŒƒå›´ä¸‹è½½åŠŸèƒ½
- ğŸ¯ æ™ºèƒ½äº¤æ˜“æ—¥å†é€‰æ‹©ç­–ç•¥
- ğŸ› ä¿®å¤ç»­ä¼ é€»è¾‘ä¸­çš„æ‰¹æ¬¡è®¡ç®—é”™è¯¯
- ğŸ”§ ä¼˜åŒ–ä¸‹è½½æ€§èƒ½å’Œé”™è¯¯å¤„ç†

### v2.0.0 (2024-10-10)
- ğŸ‰ ç»Ÿä¸€äº†æ•°æ®æºé™æµæœºåˆ¶
- ğŸ“Š æ·»åŠ äº†æ•°æ®è´¨é‡è¯„åˆ†ç³»ç»Ÿ
- ğŸš€ æ”¯æŒä¸€æ¬¡æ€§ä¸‹è½½æ¨¡å¼
- ğŸ›¡ï¸ å¢å¼ºäº†é”™è¯¯æ¢å¤æœºåˆ¶

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ `log/sys.log`
2. æ£€æŸ¥é…ç½®æ–‡ä»¶ `config/config.json`
3. å‚è€ƒæ•…éšœæ’é™¤æ–‡æ¡£
4. æäº¤ Issue åé¦ˆé—®é¢˜